<template>
  <div data-name="upload" class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
            <a href="#" class="link back">
                <i class="icon icon-back"></i>
                <span class="ios-only">Back</span>
            </a>
        </div>
        <div class="center">QR Barcode</div>
        <div class="right"><a href="#" class="link open-panel icon-only"><i class="icon icon-bars"></i></a></div>
      </div>
    </div>
    <div class="page-content">

      <div class="content-block">
        <form class="upload-form form-ajax-submit">
          <input type="hidden" name="filedata" value="" id="filedata" />
          <input type="hidden" name="komentar" value="" id="komentar" />
          <input type="hidden" name="jam_dtg"  value="" id="jam_dtg" />
        </form>
      </div>

      <div class="card">
        <div class="card-header"><span style="display: block;margin: auto;">{{nama}}</span></div>
        <div class="card-content">
          <div class="card-content-inner" style="padding: 15px;"><img id="barcode" src="https://bwipjs-api.metafloor.com/?bcid=qrcode&text={{code}}" style="display: block; margin: auto; width: 165px; height: 165px;"></div>
        </div>
        <div class="card-footer"><span style="display: block;margin: auto;"><b>{{code}}</b></span></div>
        <div class="card-footer">
          <a href="#" class="button button-fill btn-scan" style="display: block;margin: auto;">Scan QR</a>
          <!-- <a href="#" spkid="{{spkid}}" class="button button-fill btn-share">Share</a> -->
        </div>
      </div>
    
      <div class="kb"></div>
    </div>
  </div>
</template>
<script>
    return {
      // Page Events
      on: {
        
        pageInit: function(e, page) {

          // var code = localStorage.getItem('mbrid');
          // img/noimage.png
          
          // $$('#barcode').attr('src', 'https://bwipjs-api.metafloor.com/?bcid=qrcode&text='+code);
          // cordova.plugins.barcodeScanner.encode(cordova.plugins.barcodeScanner.Encode.TEXT_TYPE, code, function(success) {
          //     // $$('#barcode').attr('src', success.file);
          //     alert("encode success: " + success);
          //   }, function(fail) {
          //     alert("encoding failed: " + fail);
          //   }
          // );

          var ac_photo = app.actions.create({
            buttons: [
              {
                text: 'Belanja',
                onClick: function () {
                  QRScanner.prepare(onDone); // show the prompt

                  function onDone(err, status){
                    if (err) {
                    // here we can handle errors and clean up any loose ends.
                    console.error(err);
                    }
                    if (status.authorized) {
                      // W00t, you have camera access and the scanner is initialized.
                      // QRscanner.show() should feel very fast.
                    } else if (status.denied) {
                    // The video preview will remain black, and scanning is disabled. We can
                    // try to ask the user to change their mind, but we'll have to send them
                    // to their device settings with `QRScanner.openSettings()`.
                    } else {
                      // we didn't get permission, but we didn't get permanently denied. (On
                      // Android, a denial isn't permanent unless the user checks the "Don't
                      // ask again" box.) We can ask again at the next relevant opportunity.
                    }
                  }
                  // Start a scan. Scanning will continue until something is detected or
                  // `QRScanner.cancelScan()` is called.
                  QRScanner.scan(displayContents);

                  function displayContents(err, text){
                    if(err){
                      // an error occurred, or the scan was canceled (error code `6`)
                    } else {
                      // The scan completed, display the contents of the QR code:
                      // alert(text);
                      app.router.navigate('/belanja/'+result, {
                        reloadCurrent: true,
                        ignoreCache: true,
                      });
                    }
                  }

                  // Make the webview transparent so the video preview is visible behind it.
                  QRScanner.show();
                  // Be sure to make any opaque HTML elements transparent here to avoid
                  // covering the video.

                  cloudSky.zBar.scan({
                    text_title: "Scan QR Code", // Android only
                    text_instructions: "Tempatkan barcode pada area scan",
                    camera: "back", // defaults to "back"
                    flash: "auto", // defaults to "auto". See Quirks
                    drawSight: true //defaults to true, create a red sight/line in the center of the scanner view.
                  }, function (result){
                    app.router.navigate('/belanja/'+result, {
                      reloadCurrent: true,
                      ignoreCache: true,
                    });
                  }, function (error){
                  });
    
                  /*
                  cordova.plugins.barcodeScanner.scan(
                    function (result) {
                        var code = result.text;
                        app.router.navigate('/belanja/'+code, {
                          reloadCurrent: true,
                          ignoreCache: true,
                        });
                        // alert("We got a barcode\n" +
                              // "Result: " + result.text + "\n" +
                              // "Format: " + result.format + "\n" +
                              // "Cancelled: " + result.cancelled);
                    },
                    function (error) {
                        app.dialog.alert("Scanning failed: " + error);
                    },
                    {
                        preferFrontCamera : false, // iOS and Android
                        showFlipCameraButton : false, // iOS and Android
                        showTorchButton : true, // iOS and Android
                        torchOn: true, // Android, launch with the torch switched on (if available)
                        saveHistory: false, // Android, save scan history (default false)
                        prompt : "Tempatkan barcode pada area scan", // Android
                        resultDisplayDuration: 500, // Android, display scanned text for X ms. 0 suppresses it entirely, default 1500
                        formats : "EAN_13,CODE_128,QR_CODE,PDF_417", // default: all but PDF_417 and RSS_EXPANDED
                        orientation : "portrait", // Android only (portrait|landscape), default unset so it rotates with the device
                        disableAnimations : true, // iOS
                        disableSuccessBeep: false // iOS and Android
                    }
                  );*/
                }
              },
              {
                text: 'Transfer Saldo',
                onClick: function () {
                      
                  QRScanner.prepare(onDone); // show the prompt

                  function onDone(err, status){
                    if (err) {
                    // here we can handle errors and clean up any loose ends.
                    console.error(err);
                    }
                    if (status.authorized) {
                      // W00t, you have camera access and the scanner is initialized.
                      // QRscanner.show() should feel very fast.
                    } else if (status.denied) {
                    // The video preview will remain black, and scanning is disabled. We can
                    // try to ask the user to change their mind, but we'll have to send them
                    // to their device settings with `QRScanner.openSettings()`.
                    } else {
                      // we didn't get permission, but we didn't get permanently denied. (On
                      // Android, a denial isn't permanent unless the user checks the "Don't
                      // ask again" box.) We can ask again at the next relevant opportunity.
                    }
                  }
                  // Start a scan. Scanning will continue until something is detected or
                  // `QRScanner.cancelScan()` is called.
                  QRScanner.scan(displayContents);

                  function displayContents(err, text){
                    if(err){
                      // an error occurred, or the scan was canceled (error code `6`)
                    } else {
                      // The scan completed, display the contents of the QR code:
                      // alert(text);
                      app.router.navigate('/transfer-saldo/'+text, {
                        reloadCurrent: true,
                        ignoreCache: true,
                      });
                    }
                  }

                  // Make the webview transparent so the video preview is visible behind it.
                  QRScanner.show();
                  // Be sure to make any opaque HTML elements transparent here to avoid
                  // covering the video.

                  // cloudSky.zBar.scan({
                  //   text_title: "Scan QR Code", // Android only
                  //   text_instructions: "Tempatkan barcode pada area scan",
                  //   camera: "back", // defaults to "back"
                  //   flash: "auto", // defaults to "auto". See Quirks
                  //   drawSight: true //defaults to true, create a red sight/line in the center of the scanner view.
                  // }, function (result){
                  //   app.router.navigate('/transfer-saldo/'+result, {
                  //     reloadCurrent: true,
                  //     ignoreCache: true,
                  //   });
                  // }, function (error){
                  // });
                }
              },
              {
                text: 'Cancel',
                color: 'red',
                // onClick: function () {
                //   app.dialog.alert('Cancel clicked')
                // }
              },
            ]
          });
          
          // ambil foto
          $$('.btn-scan').on('click', function (e) {
            ac_photo.open();
          });
          
          // share barcode
          $$('.btn-share').on('click', function (e) {
          });                    
        }
      }
    }
</script>